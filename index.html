<html>
<head>
<title>Dragon</title>
</head>
<body style="background-color:black; color:#AAA;">
	<canvas id="myCanvas" style="display:block; position:absolute; top:0px; left:50%;"></canvas>
	<div style='position:absolute; top:1em; left:1em;' id='info'></div>
	<div style='position:absolute; top:1em; left:50%; text-align:center; pointer-events:none;' id='display'></div>
<script>
pi = Math.PI;

CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
  if (w < 2 * r) { r = w / 2; }
  if (h < 2 * r) { r = h / 2; }
  this.beginPath();
  this.moveTo(x+r, y);
  this.arcTo(x+w, y,   x+w, y+h, r);
  this.arcTo(x+w, y+h, x,   y+h, r);
  this.arcTo(x,   y+h, x,   y,   r);
  this.arcTo(x,   y,   x+w, y,   r);
  this.closePath();
  return this;
};

var display_box = document.getElementById('display');
function display(s, t, color) {
	if(!t) { t=2000; }
	if(!color) { color='red'; }
	display_box.style.color = color;
	display_box.innerHTML = s;
	display_box.style.display = 'block';
	setTimeout("display_box.style.display='none';", t);
}

var Player = (function() {
	function Player() {
		this.a = pi/2;
		this.da = 0.0;
		this.max_da = 0.002;
		this.dda = 0.0001;
		this.sin_neg_a = Math.sin(-this.a);
		this.cos_neg_a = Math.cos(-this.a);
		this.x = 0.0;
		this.y = 500.0;
		this.z = 1.0;
		this.dx = 0.0;
		this.dy = 0.0;
		this.dz = 0.001;
		this.max_v = 0.5;
		this.v = this.max_v*0.5;
		this.dv = 0.000;
		this.max_dv = 0.001;
		this.ddv = 0.0002;
		this.fire_size = 0.0;
		this.max_fire_size = 100.0;
		this.fire_speed = 5.0;
		this.max_health = 100;
		this.health = this.max_health;
		this.sprite_cycle_length = 10.0;
		this.sprite_cycle_index = 0.0;
		this.sprite_cycle_speed = 0.02;
	}
	return Player;
})();

NONE = 0; BULLET = 1; CANNONBALL = 2;
CANNON = 3; WAGON = 4; INFANTRY = 5;
CAVALRY = 6; PROJECTILES = 7;

var MapObject = (function() {
	function MapObject(type,x,y,a,burned,cooldown) {
		this.type = type;
		this.x = x || -1000.0;
		this.y = y || -1000.0;
		this.a = a || 0.0;
		this.burned = burned || false;
		this.cooldown = cooldown || 0.0;
		this.v = 0.0;
		this.dx = 0.0;
		this.dy = 0.0;
		if(type==CAVALRY) { this.v = 0.1; this.da = 0.002; }
		else if(type==INFANTRY) { this.v = 0.02; this.da = 0.002; }
		else if(type==CANNON) { this.da = 0.0002; }
	}
	return MapObject;
})();

var Map = (function() {
	function Map() {
		this.width = 2000;
		this.height = 2000;
		this.victory = false;
		this.defeat = false;
		this.hills = [];
		this.objects = [];
		this.wagon_count = 0;

		for(var i=0; i<0; i++) {
			this.hills.push( {x:Math.random()*this.width, y:Math.random()*this.height} );
		}
		
		for(var j=0; j<10; j++) { this.objects.push( new MapObject(CANNONBALL) ); }

		for(var x=0; x<this.width; x+=550) {
			for(var y=0; y<this.height; y+=550) {
				var xx = x+Math.random()*50;
				var yy = y+Math.random()*50;
				this.objects.push( new MapObject(WAGON,xx,yy,Math.random()*2*pi) );
				this.wagon_count += 1;
				
				for(var theta=0; theta<2*pi; theta+=2*pi/10) {
					var xxx = xx+Math.cos(theta)*100;
					var yyy = yy+Math.sin(theta)*100;
					if(xxx<0 || xxx>this.width || yyy<0 || yyy>this.height) { continue; }
					this.objects.push( new MapObject(CANNON,xxx,yyy,-theta-pi/2) );
					
					xxx = xx+Math.cos(theta)*50;
					yyy = yy+Math.sin(theta)*50;
					if(xxx<0 || xxx>this.width || yyy<0 || yyy>this.height) { continue; }
					this.objects.push( new MapObject(INFANTRY,xxx,yyy,-theta-pi/2) );
					
					xxx = xx+Math.cos(theta)*150;
					yyy = yy+Math.sin(theta)*150;
					if(xxx<0 || xxx>this.width || yyy<0 || yyy>this.height) { continue; }
					this.objects.push( new MapObject(CAVALRY,xxx,yyy,-theta-pi/2) );
				}
			}
		}
	}
	return Map;
})();

var me = new Player();
var map = new Map();

keys = [];
for(var i=0; i<256; i++) {
	keys[i] = false;
}
document.onkeydown = function(k) {
	keys[k.which]=true;
};
document.onkeyup = function(k) {
	keys[k.which]=false;
};
LEFT = 37; RIGHT = 39;
UP = 38; DOWN = 40;
SPACE = 32;

var canvas=document.getElementById("myCanvas");
canvas.height = window.innerHeight;
canvas.width = canvas.height * 340/480;
canvas.style.marginLeft = (-canvas.width/2)+'px';
display_box.style.width = canvas.width+'px';
display_box.style.marginLeft = canvas.style.marginLeft;
var scale = canvas.height/480;
display_box.style.fontSize = (40*scale)+'px';
var look_distance = 480;
var g=canvas.getContext("2d");
canvas.style.backgroundColor = "#0A1";

info = document.getElementById('info');
display('Objective: burn all supply wagons', 3000);

previous_time = +new Date();
function draw() {
	requestAnimationFrame(draw);
	current_time = +new Date();
	dt = current_time - previous_time;
	previous_time = current_time;
	if(dt>500) { return; } //pause while offscreen
	
	if(map.defeat) { //defeat
		return;
	}
	if(map.victory) { //victory
		return;
	}
	
	if(keys[LEFT] && me.da>-me.max_da) { me.da -= me.dda; }
	else if(keys[RIGHT] && me.da<me.max_da) { me.da += me.dda; }
	else if(!keys[LEFT] && !keys[RIGHT]) { me.da = 0.0; }
	
	if(keys[DOWN] && me.dv>-me.max_dv) { me.dv -= me.ddv*2; }
	else if(keys[UP] && me.dv<me.max_dv) { me.dv += me.ddv; }
	else if(!keys[DOWN] && !keys[UP]) { me.dv = 0.0; }
	
	if(keys[SPACE]) {
		me.fire_size += me.fire_speed;
		if(me.fire_size==me.max_fire_size) { me.fire_size=0.0; }
		if(me.fire_size>me.max_fire_size) { me.fire_size=me.max_fire_size; }
	}
	else { me.fire_size = 0.0; }
	
	me.a += dt*me.da;
	if(me.da!==0.0) {
		me.sin_neg_a = Math.sin(-me.a);
		me.cos_neg_a = Math.cos(-me.a);
	}
	me.v += dt*me.dv;
	if(me.v>me.max_v) { me.v = me.max_v; }
	else if(me.v<me.max_v*0.3) { me.v = me.max_v*0.3; }
	
	me.dx = -me.v*me.sin_neg_a;
	me.dy = -me.v*me.cos_neg_a;
	me.x += dt*me.dx;
	me.y += dt*me.dy;
	if(me.x<0.0) { me.x = 0.0; }
	if(me.y<0.0) { me.y = 0.0; }
	if(me.x>map.width-0) { me.x = map.width-0; }
	if(me.y>map.height-0) { me.y = map.height-0; }
	
	var valid_projectile = null;
	var nearest_goal = null;
	var nearest_goal_distance = 1e6;
	for(var i=0; i<map.objects.length; i++) { //game logic
		var o = map.objects[i];
		if(o.type==CANNONBALL || o.type==BULLET) {
			var p = o;
			if( p.x == -1000.0 ) { valid_projectile = p; continue; }
			p.x += dt*p.dx;
			p.y += dt*p.dy;
			if((me.x-p.x)*(me.x-p.x) + (me.y-p.y)*(me.y-p.y) > look_distance*look_distance) {
				p.x = -1000.0; p.y = -1000.0;
			}
			else if((me.x-p.x)*(me.x-p.x) + (me.y-p.y)*(me.y-p.y) < 20*20) {
				var kinetic_energy = (p.dx-me.dx)*(p.dx-me.dx) + (p.dy-me.dy)*(p.dy-me.dy);
				var damage = 5*((30.0*kinetic_energy)|0);
				if(p.type==BULLET) { damage = ((5.0*kinetic_energy)|0); }
				if(damage===0) { continue; }
				p.x = -1000.0; p.y = -1000.0;
				me.health -= damage;
				if(me.health<=0) {
					map.defeat = true;
					display('We are defeated!<br>Pull back!', 5000);
				}
			}
		}
		else if(o.type==CANNON || o.type==INFANTRY || o.type==CAVALRY) {
			var c = o;
			if( (c.x-me.x)*(c.x-me.x) + (c.y-me.y)*(c.y-me.y) > look_distance*look_distance) { continue; }
			
			c.dx = -c.v*Math.sin(c.a);
			c.dy = -c.v*Math.cos(c.a);
			o.x += dt*o.dx;
			o.y += dt*o.dy;
			if(o.x<0.0) { o.x = 0.0; }
			if(o.y<0.0) { o.y = 0.0; }
			if(o.x>map.width-0) { o.x = map.width-0; }
			if(o.y>map.height-0) { o.y = map.height-0; }
			
			var x = me.x - me.sin_neg_a*60;
			var y = me.y - me.cos_neg_a*60;
		
			var aim_angle = Math.atan2(c.x-me.x, c.y-me.y);
			var dif = c.a-aim_angle;
			if(Math.abs(dif)>Math.abs(c.a-aim_angle+2*pi)) { dif = c.a-aim_angle+2*pi; }
			if(Math.abs(dif)>Math.abs(c.a-aim_angle-2*pi)) { dif = c.a-aim_angle-2*pi; }
	
			c.a += (dif<0.0 ? c.da : -c.da)*dt;
			if(c.a<-pi) { c.a+=2*pi; }
			else if(c.a>pi) { c.a-=2*pi; }
		
			if(c.cooldown>0.0) { c.cooldown -= dt; }
			else { c.cooldown = 0.0; }
		
			if( (c.x-x)*(c.x-x) + (c.y-y)*(c.y-y) < me.fire_size*me.fire_size*0.7*0.7 ) {
				c.x = -1000.0; c.y = -1000.0;
			}
			else if(valid_projectile && c.cooldown<=0 && (c.x-x)*(c.x-x) + (c.y-y)*(c.y-y) < 200*200) {
				var sin_a = Math.sin(c.a);
				var cos_a = Math.cos(c.a);
				valid_projectile.x = c.x - 20*sin_a;
				valid_projectile.y = c.y - 20*cos_a;
				if(c.type==CANNON) {
					valid_projectile.dx = -0.2*sin_a;
					valid_projectile.dy = -0.2*cos_a;
					valid_projectile.type=CANNONBALL;
				}
				else {
					valid_projectile.dx = -0.4*sin_a;
					valid_projectile.dy = -0.4*cos_a;
					valid_projectile.type=BULLET;
				}
				c.cooldown = 3000;
			}
		}
		else if(o.type==WAGON) {
			var w = o;
			var dist_squared = (w.x-me.x)*(w.x-me.x) + (w.y-me.y)*(w.y-me.y)
			if(!w.burned && dist_squared<nearest_goal_distance) {
				nearest_goal = w;
				nearest_goal_distance = dist_squared;
			}
			if( dist_squared > look_distance*look_distance) { continue; }
			var x = me.x - me.sin_neg_a*60;
			var y = me.y - me.cos_neg_a*60;
			
			if( (w.x-x)*(w.x-x) + (w.y-y)*(w.y-y) < me.fire_size*me.fire_size*1.0*1.0 ) {
				w.burned = true;
				var burned_count = 0;
				for(var j=0; j<map.objects.length; j++) {
					if( map.objects[j].burned ) { burned_count+=1; }
				}
				if(burned_count==map.wagon_count) {
					map.victory = true;
					display('Victory!', 10000, 'blue');
				}
			}
		}
	}
	
	info.innerHTML = Math.round(1000/dt)+'fps';
	canvas.width = canvas.width;
	g.scale(scale, scale);
	g.save();
	g.translate(canvas.width/2/scale, canvas.height/scale-50);
	g.rotate(-me.a);
	g.translate(-canvas.width/2/scale, -canvas.height/scale+50);
	g.translate(-me.x+canvas.width/2/scale, -me.y+canvas.height/scale-50);
	
	for(var i=0; i<map.hills.length; i++) {
		var h = map.hills[i];
		if( (h.x-me.x)*(h.x-me.x) + (h.y-me.y)*(h.y-me.y) > look_distance*look_distance ) { continue; }
		
		var grd=g.createRadialGradient(h.x,h.y,5,h.x,h.y,200);//(75,75,5,90,90,100);
		grd.addColorStop(0,'#0A2');
		grd.addColorStop(1,canvas.style.backgroundColor);
		g.fillStyle=grd;
		g.fillRect(h.x-200,h.y-200,400,400);
	}
	
	g.beginPath();
	for (var x=0; x<map.width+1; x+=50) {
		g.moveTo(x, 0);
		g.lineTo(x, map.height);
	}
	for(var y=0; y<map.height+1; y+=50) {
		g.moveTo(0, y);
		g.lineTo(map.width, y);
	}
	g.strokeStyle = "#00A";
	g.stroke();
	
	for(var i=0; i<map.objects.length; i++) {
		var o = map.objects[i];
		if( (o.x-me.x)*(o.x-me.x) + (o.y-me.y)*(o.y-me.y) > look_distance*look_distance ) { continue; }
		g.save();
		if(o.type==CANNON) {
			var c = o;
			g.translate(c.x, c.y);
			g.rotate(-c.a);
			var cannon_width = 10;
			var wheel_width = 5;
			var wheel_length = 30;
			var cannon_length = 40;
			g.fillStyle='#961';
			g.fillRect(cannon_width/2+3, -wheel_length/2, wheel_width, wheel_length);
			g.fillRect(-cannon_width/2-wheel_width-3, -wheel_length/2, wheel_width, wheel_length);
			g.fillRect(-cannon_width/2-3, -5, cannon_width+2*3, 10);
			g.fillStyle='#444';
			g.fillRect(-cannon_width/2, -12-wheel_length/2, cannon_width, cannon_length);
		}
		else if(o.type==WAGON) {
			var w = o;
			g.translate(w.x, w.y);
			g.rotate(-w.a);
			g.fillStyle = w.burned ? '#000' : '#851';
			g.fillRect(-15, -30, 30, 60);
		
			g.fillRect(15+1, 5, 3, 20);
			g.fillRect(-15-3-1, 5, 3, 20);
		
			g.fillRect(15+1, -25, 3, 20);
			g.fillRect(-15-3-1, -25, 3, 20);
		}
		else if(o.type==INFANTRY) {
			var n = o;
			g.translate(n.x, n.y);
			g.rotate(-n.a);
			if(n.cooldown===0.0) { //draw musket
				g.fillStyle='#777';
				g.fillRect(1,-24,2,24);
				g.fillStyle='brown';
				g.fillRect(1,-18,2,18);
			}
			else { //reload
				g.fillStyle='#777';
				g.fillRect(1,-12,2,12);
				g.fillStyle='brown';
				g.fillRect(1,-9,2,9);
			}
			g.fillStyle='#F00';
			g.fillRect(-6,-3,12,6);
			g.beginPath();
			g.arc(0, 0, 4, 0, 2*pi);
			g.fillStyle='#FF5';
			g.fill();
		}
		else if(o.type==CAVALRY) {
			var c = o;
			g.translate(c.x, c.y);
			g.rotate(-c.a);
			g.fillStyle='#631';
			//g.fillRect(-6, -18, 6*2, 18*2);
			g.roundRect(-6, -18, 6*2, 18*2, 4).fill();
			g.roundRect(-3, -28, 6, 12, 3).fill();

			g.fillStyle='#777';
			g.fillRect(1,-24,2,24);
			g.fillStyle='brown';
			g.fillRect(1,-18,2,18);
			
			g.fillStyle='#F00';
			g.fillRect(-6,-3,12,6);
			g.beginPath();
			g.arc(0, 0, 4, 0, 2*pi);
			g.fillStyle='#FF5';
			g.fill();
		}
		else if(o.type==CANNONBALL || o.type==BULLET) {
			var p = o;
			g.beginPath();
			if(p.type==CANNONBALL) {
				g.arc(p.x, p.y, 5, 0, 2*pi);
				g.fillStyle='#222';
			}
			else if(p.type==BULLET) {
				g.arc(p.x, p.y, 2, 0, 2*pi);
				g.fillStyle='#222';
			}
			g.fill();
		}
		g.restore();
	}

	g.beginPath();
	g.moveTo(me.x, me.y);
	g.lineTo(nearest_goal.x, nearest_goal.y);
	g.strokeStyle = '#00A';
	g.stroke();
	
	g.restore();
	
	me.sprite_cycle_index += dt*me.sprite_cycle_speed*me.v/me.max_v;
	if(me.sprite_cycle_index>me.sprite_cycle_length) { me.sprite_cycle_index=0; }
	var index = me.sprite_cycle_index|0;
	
	var q = Math.sin(2*pi*me.sprite_cycle_index/me.sprite_cycle_length);
	var s = 1+0.3*q;
	q *= 0.1;
	g.save();
	g.translate(canvas.width/2/scale, canvas.height/scale-80);
	
	g.beginPath();
	g.moveTo(0,-10);
	g.quadraticCurveTo(0,-me.fire_size*0.5, me.fire_size,-me.fire_size);
	g.lineTo(-me.fire_size,-me.fire_size);
	g.quadraticCurveTo(0,-me.fire_size*0.5, 0,-10);
	g.fillStyle = '#F00';
	g.fill();
	g.beginPath();
	g.moveTo(0,-10);
	g.quadraticCurveTo(0,-me.fire_size*0.5, me.fire_size*0.5,-me.fire_size);
	g.lineTo(-me.fire_size*0.5,-me.fire_size);
	g.quadraticCurveTo(0,-me.fire_size*0.5, 0,-10);
	g.fillStyle = '#FF0';
	g.fill();
	
	g.beginPath();
	g.moveTo(0,0);
	g.lineTo(48*s,0-q*48);
	g.quadraticCurveTo(36*s,15-q*36, 36*s,25-q*36);
	g.quadraticCurveTo(36*s,15-q*24, 24*s,5-q*24);
	g.quadraticCurveTo(12*s,15-q*12, 12*s,25-q*12);
	g.quadraticCurveTo(12*s,15, 0,0);
	g.lineTo(-48*s,0-q*48);
	g.quadraticCurveTo(-36*s,15-q*36, -36*s,25-q*36);
	g.quadraticCurveTo(-36*s,15-q*24, -24*s,5-q*24);
	g.quadraticCurveTo(-12*s,15-q*12, -12*s,25-q*12);
	g.quadraticCurveTo(-12*s,15, 0,0);
	g.bezierCurveTo(10, 20, -10, 30, 0, 50);
	g.bezierCurveTo(-20, 30, 20, 20, 0, 0);
	g.lineTo(5,-1);
	g.lineTo(0,-10);
	g.lineTo(-5,-1);
	//g.fillStyle = '#000';
	var grd=g.createRadialGradient(0,20, 40*s, 0,20, 50*s);
	grd.addColorStop(0,'#000');
	grd.addColorStop(1,'#FF0');
	g.fillStyle=grd;
	g.fill();
	g.restore();
	
	//health bar
	g.fillStyle = '#F00';
	g.fillRect(5, 5, (canvas.width/scale-5*2)*Math.max(me.health/me.max_health, 0), 5);
}
draw();

</script>
</body>
</html>

