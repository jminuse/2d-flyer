<!DOCTYPE html>
<html>
<head>
<title>The Republic's Dragon</title>
<meta name="viewport" content="width=device-width, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body style="background-color:black; color:#AAA; overflow:hidden;">
	<canvas id="myCanvas" style="display:block; position:absolute; top:0px; left:50%; background:#0A1;"></canvas>
	<div style='position:absolute; top:1em; left:1em;' id='info'></div>
	<div style='position:absolute; top:1em; left:50%; text-align:center; pointer-events:none;' id='display'></div>
	<div class='bookmark' id='single-game-button'>Single game</div>
	<div class='bookmark' id='campaign-button'>Campaign</div>
<script>
CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
  if (w < 2 * r) { r = w / 2; }
  if (h < 2 * r) { r = h / 2; }
  this.beginPath();
  this.moveTo(x+r, y);
  this.arcTo(x+w, y,   x+w, y+h, r);
  this.arcTo(x+w, y+h, x,   y+h, r);
  this.arcTo(x,   y+h, x,   y,   r);
  this.arcTo(x,   y,   x+w, y,   r);
  this.closePath();
  return this;
};
CanvasRenderingContext2D.prototype.star = function(x, y, r, p, m) {
	this.save();
	this.beginPath();
	this.translate(x, y);
	this.moveTo(0,0-r);
	for (var i = 0; i < p; i++) {
		this.rotate(Math.PI / p);
		this.lineTo(0, 0 - (r*m));
		this.rotate(Math.PI / p);
		this.lineTo(0, 0 - r);
	}
	this.restore();
	return this;
};
CanvasRenderingContext2D.prototype.dragon = function(q,s) {
	g.beginPath();
	g.moveTo(0,0);
	g.lineTo(48*s,0-q*48);
	g.quadraticCurveTo(36*s,15-q*36, 36*s,25-q*36);
	g.quadraticCurveTo(36*s,15-q*24, 24*s,5-q*24);
	g.quadraticCurveTo(12*s,15-q*12, 12*s,25-q*12);
	g.quadraticCurveTo(12*s,15, 0,0);
	g.lineTo(-48*s,0-q*48);
	g.quadraticCurveTo(-36*s,15-q*36, -36*s,25-q*36);
	g.quadraticCurveTo(-36*s,15-q*24, -24*s,5-q*24);
	g.quadraticCurveTo(-12*s,15-q*12, -12*s,25-q*12);
	g.quadraticCurveTo(-12*s,15, 0,0);
	g.bezierCurveTo(10, 20, -10, 30, 0, 50);
	g.bezierCurveTo(-20, 30, 20, 20, 0, 0);
	g.lineTo(5,-1);
	g.lineTo(0,-10);
	g.lineTo(-5,-1);
	//g.fillStyle = '#000';
	var grd=g.createRadialGradient(0,20, 40*s, 0,20, 50*s);
	grd.addColorStop(0,'#000');
	grd.addColorStop(1,'#FF0');
	g.fillStyle=grd;
	g.fill();
};

var display_box = document.getElementById('display');
function display(s, t, color) {
	if(t===undefined) { t=2000; }
	if(!color) { color='red'; }
	display_box.style.color = color;
	display_box.innerHTML = s;
	display_box.style.display = 'block';
	if(t) { setTimeout("display_box.style.display='none';", t); }
}

var Player = (function() {
	function Player() {
		this.a = Math.PI/2;
		this.da = 0.0;
		this.max_da = 0.002;
		this.dda = 0.0002;
		this.sin_neg_a = Math.sin(-this.a);
		this.cos_neg_a = Math.cos(-this.a);
		this.x = 0.0;
		this.y = 500.0;
		this.z = 1.0;
		this.dx = 0.0;
		this.dy = 0.0;
		this.dz = 0.001;
		this.max_v = 0.5;
		this.v = this.max_v*0.5;
		this.dv = 0.000;
		this.max_dv = 0.001;
		this.ddv = 0.0002;
		this.fire_size = 0.0;
		this.max_fire_size = 100.0;
		this.fire_speed = 0.1;
		this.fire_time_max = 1000.0;
		this.fire_time = 0.0;
		this.max_health = 100;
		this.health = this.max_health;
		this.sprite_cycle_length = 10.0;
		this.sprite_cycle_index = 0.0;
		this.sprite_cycle_speed = 0.02;
	}
	return Player;
})();

NONE = 0; BULLET = 1; CANNONBALL = 2;
CANNON = 3; WAGON = 4; INFANTRY = 5;
CAVALRY = 6; PROJECTILES = 7;

var MapObject = (function() {
	function MapObject(type,x,y,a,guarding,burned,cooldown) {
		this.type = type;
		this.x = x || -1000.0;
		this.y = y || -1000.0;
		this.a = a || 0.0;
		this.guarding = guarding || null;
		this.burned = burned || false;
		this.cooldown = cooldown || 0.0;
		this.v = 0.0;
		this.dx = 0.0;
		this.dy = 0.0;
		if(type==CAVALRY) { this.v = 0.06; this.da = 0.002; this.guarding_distance=200; }
		else if(type==INFANTRY) { this.v = 0.02; this.da = 0.002; this.guarding_distance=100; }
		else if(type==CANNON) { this.da = 0.0002; this.guarding_distance=100; }
	}
	return MapObject;
})();

var Map = (function() {
	function Map(game) {
		this.loss_condition = function(game) { return game.me.health<=0; }
		if(game.mode==game.SINGLE_GAME) {
			this.objective_string = 'Objective: burn all supply wagons';
			this.win_condition = function() { return game.map.wagon_count==game.map.wagons_burned_count; }
			this.is_goal = function(obj) { return !obj.burned && obj.type==WAGON; }
		}
		else {
			this.objective_string = 'Objective: destroy all enemies';
			this.win_condition = function(game) { return game.map.enemy_count==game.map.enemies_destroyed_count; }
			this.is_goal = function(obj) { return !obj.burned && obj.type!=BULLET && obj.type!=CANNONBALL; }
		}
		this.width = 2000;
		this.height = 2000;
		this.victory = false;
		this.defeat = false;
		this.hills = [];
		this.objects = [];
		this.wagon_count = 0;
		this.wagons_burned_count = 0;
		this.enemy_count=0;
		this.enemies_destroyed_count=0;

		for(var i=0; i<0; i++) {
			this.hills.push( {x:Math.random()*this.width, y:Math.random()*this.height} );
		}
		
		for(var j=0; j<10; j++) { this.objects.push( new MapObject(CANNONBALL) ); }

		for(var k=0; k<10; k++) {
			do {
				var x=Math.random()*this.width;
				var y=Math.random()*this.height;
				var nearest_d2 = 1e6;
				for(var i=0; i<this.objects.length; i++) {
					var o = this.objects[i];
					var d2 = (o.x-x)*(o.x-x) + (o.y-y)*(o.y-y);
					nearest_d2 = Math.min(nearest_d2, d2);
				}
			} while(nearest_d2<150*150);
		
			var xx = x+Math.random()*50;
			var yy = y+Math.random()*50;
			var w = new MapObject(WAGON,xx,yy,Math.random()*2*Math.PI);
			this.objects.push( w );
			this.enemy_count += 1;
			this.wagon_count += 1;
			
			for(var theta=0; theta<2*Math.PI; theta+=2*Math.PI/10) {
				var xxx = xx+Math.cos(theta)*100;
				var yyy = yy+Math.sin(theta)*100;
				if(xxx<0 || xxx>this.width || yyy<0 || yyy>this.height) { continue; }
				this.objects.push( new MapObject(CANNON,xxx,yyy,-theta-Math.PI/2,w) );
				this.enemy_count += 1;
				
				xxx = xx+Math.cos(theta)*50;
				yyy = yy+Math.sin(theta)*50;
				if(xxx<0 || xxx>this.width || yyy<0 || yyy>this.height) { continue; }
				this.objects.push( new MapObject(INFANTRY,xxx,yyy,-theta-Math.PI/2,w) );
				this.enemy_count += 1;
				
				xxx = xx+Math.cos(theta)*150;
				yyy = yy+Math.sin(theta)*150;
				if(xxx<0 || xxx>this.width || yyy<0 || yyy>this.height) { continue; }
				this.objects.push( new MapObject(CAVALRY,xxx,yyy,-theta-Math.PI/2,w) );
				this.enemy_count += 1;
			}
		}
		for(var m=0; m<100; m++) {
			var x=Math.random()*this.width;
			var y=Math.random()*this.height;
			this.objects.push( new MapObject(INFANTRY,x,y,Math.random()*Math.PI*2,w) );
			this.enemy_count += 1;
		}
	}
	return Map;
})();

var Game = (function() {
	function Game() {
		this.NOT_STARTED = 0; this.SINGLE_GAME = 1; this.CAMPAIGN = 2;
		this.mode = this.NOT_STARTED;
		this.level = 0;
		display("<div style='font-size:200%; margin-top:-0.5em;'>The Republic's Dragon</div>", false, 'black');
	}
	Game.prototype.next_level = function() {
		if(this.mode==this.CAMPAIGN) {
			this.level+=1;
		}
		this.map = new Map(this);
		this.me = new Player();
		display(this.map.objective_string, 3000);
		map = this.map;
		me = this.me;
	};
	return Game;
})();

var game = new Game();

keys = [];
for(var i=0; i<256; i++) {
	keys[i] = false;
}
document.onkeydown = function(k) {
	keys[k.which]=true;
};
document.onkeyup = function(k) {
	keys[k.which]=false;
};
LEFT = 37; RIGHT = 39;
UP = 38; DOWN = 40;
SPACE = 32;

touchscreen_touched = false;
if('ontouchstart' in document) {
	document.ontouchstart = function(e) {
		touchscreen_touched=true;
	};
	document.ontouchend = function(e) {
		touchscreen_touched=false;
	};
	document.ontouchmove = function(e) {
		e.preventDefault(); //stop rubber band effect
	};
}

orientation_set = false;
if (window.DeviceOrientationEvent) {
  window.ondeviceorientation = function(event) {
		if(!orientation_set) {
			if(event.gamma===null && event.beta===null && event.alpha===null) { window.ondeviceorientation=null; return; } // reject false devices
			default_left_right_tilt = event.gamma; // left-to-right tilt in degrees, where right is positive
			default_forward_back_tilt = event.beta; // front-to-back tilt in degrees, where front is positive
			default_compass_direction = event.alpha; // compass direction the device is facing in degrees
			orientation_set = true;
		}
  	left_right_tilt = event.gamma - default_left_right_tilt;
  	forward_back_tilt = event.beta - default_forward_back_tilt;
  	compass_direction = event.alpha - default_compass_direction;
  };
}

var canvas=document.getElementById("myCanvas");
canvas.height = window.innerHeight;
canvas.width = canvas.height * 340/480;
canvas.style.marginLeft = (-canvas.width/2)+'px';
display_box.style.width = canvas.width+'px';
display_box.style.marginLeft = canvas.style.marginLeft;
var scale = canvas.height/480;
display_box.style.fontSize = (40*scale)+'px';

var single_game_button=document.getElementById("single-game-button");
single_game_button.style.top = (canvas.height-60*scale)+'px';

var campaign_button=document.getElementById("campaign-button");
campaign_button.style.top = (canvas.height-100*scale)+'px';

var head = document.getElementsByTagName('head')[0];
var style = document.createElement('style');
var rules = document.createTextNode(".bookmark{position:absolute;background-color:#27F; color:black; cursor:pointer;right:"+canvas.offsetLeft+"px;font-size:"+(22*scale)+"px;padding:"+(3*scale)+"px;padding-left:"+(17*scale)+"px;}\n.bookmark:after{content:'';display:block;border:"+(15*scale)+"px solid transparent;border-left-color:#0A1;position:absolute;left:0;bottom:0;}");
style.type = 'text/css';
if(style.styleSheet) { style.styleSheet.cssText = rules.nodeValue; }
else { style.appendChild(rules); }
head.appendChild(style);

var look_distance = 480;
var g=canvas.getContext("2d");

info = document.getElementById('info');
single_game_button.onmousedown = function(e) {
	game.mode=game.SINGLE_GAME;
	single_game_button.style.display='none';
	campaign_button.style.display='none';
	game.next_level();
}
campaign_button.onmousedown = function(e) {
	game.mode=game.CAMPAIGN;
	single_game_button.style.display='none';
	campaign_button.style.display='none';
	game.next_level();
}


function controls(dt) {
	if(orientation_set) { //accelerometer controls
		var dead_band = 2; //degrees
		var range = 40;
		var left_right_sensitivity = 10;
		var forward_back_sensitivity = 1;

		if(left_right_tilt<-dead_band && me.da>-me.max_da) { me.da = -left_right_sensitivity*me.dda*Math.min(1, Math.abs(left_right_tilt-dead_band)/range); }
		else if(left_right_tilt>dead_band && me.da<me.max_da) { me.da = left_right_sensitivity*me.dda*Math.min(1, Math.abs(left_right_tilt-dead_band)/range); }
		else if(left_right_tilt>-dead_band && left_right_tilt<dead_band) { me.da = 0.0; }

		if(forward_back_tilt>dead_band && me.dv>-me.max_dv) { me.dv = -forward_back_sensitivity*me.ddv*2*Math.min(1, Math.abs(forward_back_tilt-dead_band)/range); }
		else if(forward_back_tilt<-dead_band && me.dv<me.max_dv) { me.dv = forward_back_sensitivity*me.ddv*Math.min(1, Math.abs(forward_back_tilt-dead_band)/range); }
		else if(forward_back_tilt>-dead_band && forward_back_tilt<dead_band) { me.dv = 0.0; }
		
		if(!touchscreen_touched) {
			me.fire_size += me.fire_speed*dt;
			if(me.fire_size>=me.max_fire_size) {
				me.fire_size=me.max_fire_size;
				me.fire_time += dt;
				if(me.fire_time>me.fire_time_max) { me.fire_size=0.0; me.fire_time=0.0; }
			}
		}
		else { me.fire_size = 0.0; me.fire_time=0.0; }
	}
	else { //keyboard controls
		if(keys[LEFT] && me.da>-me.max_da) { me.da -= me.dda; }
		else if(keys[RIGHT] && me.da<me.max_da) { me.da += me.dda; }
		else if(!keys[LEFT] && !keys[RIGHT]) { me.da = 0.0; }
	
		if(keys[DOWN] && me.dv>-me.max_dv) { me.dv -= me.ddv*2; }
		else if(keys[UP] && me.dv<me.max_dv) { me.dv += me.ddv; }
		else if(!keys[DOWN] && !keys[UP]) { me.dv = 0.0; }
	
		if(keys[SPACE]) {
			me.fire_size += me.fire_speed*dt;
			if(me.fire_size>=me.max_fire_size) {
				me.fire_size=me.max_fire_size;
				me.fire_time += dt;
				if(me.fire_time>me.fire_time_max) { me.fire_size=0.0; me.fire_time=0.0; }
			}
		}
		else { me.fire_size = 0.0; me.fire_time=0.0; }
	}
}

function game_logic(dt) {
	me.a += dt*me.da;
	if(me.da!==0.0) {
		me.sin_neg_a = Math.sin(-me.a);
		me.cos_neg_a = Math.cos(-me.a);
	}
	me.v += dt*me.dv;
	if(me.v>me.max_v) { me.v = me.max_v; }
	else if(me.v<me.max_v*0.3) { me.v = me.max_v*0.3; }
	
	me.dx = -me.v*me.sin_neg_a;
	me.dy = -me.v*me.cos_neg_a;
	me.x += dt*me.dx;
	me.y += dt*me.dy;
	if(me.x<0.0) { me.x = 0.0; }
	if(me.y<0.0) { me.y = 0.0; }
	if(me.x>map.width-0) { me.x = map.width-0; }
	if(me.y>map.height-0) { me.y = map.height-0; }
	
	var valid_projectile = null;
	var nearest_goal = null;
	var nearest_goal_distance = 1e6;
	for(var i=0; i<map.objects.length; i++) {
		var o = map.objects[i];
		var dist_squared = (o.x-me.x)*(o.x-me.x) + (o.y-me.y)*(o.y-me.y);
		if(map.is_goal(o) && (!nearest_goal || dist_squared<nearest_goal_distance)) {
			nearest_goal = o;
			nearest_goal_distance = dist_squared;
		}
		if(o.type==CANNONBALL || o.type==BULLET) {
			var p = o;
			if( p.x == -1000.0 ) { valid_projectile = p; continue; }
			p.x += dt*p.dx;
			p.y += dt*p.dy;
			if((me.x-p.x)*(me.x-p.x) + (me.y-p.y)*(me.y-p.y) > look_distance*look_distance) {
				p.x = -1000.0; p.y = -1000.0;
			}
			else if((me.x-p.x)*(me.x-p.x) + (me.y-p.y)*(me.y-p.y) < 20*20) {
				var kinetic_energy = (p.dx-me.dx)*(p.dx-me.dx) + (p.dy-me.dy)*(p.dy-me.dy);
				var damage = Math.min(30, 5*((50.0*kinetic_energy)|0) );
				if(p.type==BULLET) { damage = 1; }
				if(damage===0) { continue; }
				p.x = -1000.0; p.y = -1000.0;
				me.health -= damage;
			}
		}
		else if(o.type==CANNON || o.type==INFANTRY || o.type==CAVALRY) {
			var c = o;
			if( c.burned || (c.x-me.x)*(c.x-me.x) + (c.y-me.y)*(c.y-me.y) > look_distance*look_distance) { continue; }
			
			c.dx = -c.v*Math.sin(c.a);
			c.dy = -c.v*Math.cos(c.a);
			
			if(c.guarding) {
				var guarding_distance_squared = (c.x-c.guarding.x)*(c.x-c.guarding.x) + (c.y-c.guarding.y)*(c.y-c.guarding.y);
				if( guarding_distance_squared > c.guarding_distance*c.guarding_distance ) {
					o.dx += c.x<c.guarding.x ? 0.01 : -0.01;
					o.dy += c.y<c.guarding.y ? 0.01 : -0.01;
				}
			}
			
			if( (o.x+dt*o.dx-me.x)*(o.x+dt*o.dx-me.x) + (o.y+dt*o.dy-me.y)*(o.y+dt*o.dy-me.y) > 100*100 ) {
				o.x += dt*o.dx;
				o.y += dt*o.dy;
			}
			if(o.x<0.0) { o.x = 0.0; }
			if(o.y<0.0) { o.y = 0.0; }
			if(o.x>map.width-0) { o.x = map.width-0; }
			if(o.y>map.height-0) { o.y = map.height-0; }
			
			var x = me.x - me.sin_neg_a*40;
			var y = me.y - me.cos_neg_a*40;
		
			var aim_angle = Math.atan2(c.x-me.x, c.y-me.y);
			var dif = c.a-aim_angle;
			if(Math.abs(dif)>Math.abs(c.a-aim_angle+2*Math.PI)) { dif = c.a-aim_angle+2*Math.PI; }
			if(Math.abs(dif)>Math.abs(c.a-aim_angle-2*Math.PI)) { dif = c.a-aim_angle-2*Math.PI; }
	
			c.a += (dif<0.0 ? c.da : -c.da)*dt;
			if(c.a<-Math.PI) { c.a+=2*Math.PI; }
			else if(c.a>Math.PI) { c.a-=2*Math.PI; }
		
			if(c.cooldown>0.0) { c.cooldown -= dt; }
			else { c.cooldown = 0.0; }
		
			if( (c.x-x)*(c.x-x) + (c.y-y)*(c.y-y) < me.fire_size*me.fire_size*0.7*0.7 ) {
				c.burned = true;
				map.enemies_destroyed_count+=1;
			}
			else if(valid_projectile && c.cooldown<=0 && (c.x-x)*(c.x-x) + (c.y-y)*(c.y-y) < 200*200) {
				var sin_a = Math.sin(c.a);
				var cos_a = Math.cos(c.a);
				valid_projectile.x = c.x - 20*sin_a;
				valid_projectile.y = c.y - 20*cos_a;
				if(c.type==CANNON) {
					valid_projectile.dx = -0.2*sin_a;
					valid_projectile.dy = -0.2*cos_a;
					valid_projectile.type=CANNONBALL;
				}
				else {
					valid_projectile.dx = -0.4*sin_a;
					valid_projectile.dy = -0.4*cos_a;
					valid_projectile.type=BULLET;
				}
				c.cooldown = 5000.0;
			}
		}
		else if(o.type==WAGON) {
			var w = o;
			if( w.burned || dist_squared > look_distance*look_distance) { continue; }
			var x = me.x - me.sin_neg_a*40;
			var y = me.y - me.cos_neg_a*40;
			
			if( (w.x-x)*(w.x-x) + (w.y-y)*(w.y-y) < me.fire_size*me.fire_size*1.0*1.0 ) {
				w.burned = true;
				map.wagons_burned_count+=1;
				map.enemies_destroyed_count+=1;
			}
		}
	}
	if(map.loss_condition(game)) {
		map.defeat = true;
		display('We are defeated!<br>Pull back!<br><small>Click to continue</small>', false);
		if('ontouchend' in document) {
			document.ontouchend = function() { document.ontouchend = function(e) { touchscreen_touched=false; }; game.next_level(); };
		}
		else {
			document.onmouseup = function() { document.onmouseup=null; game.next_level(); };
		}
	}
	if(map.win_condition(game)) {
		map.victory = true;
		display('Victory!<br><small>Click to continue</small>', false, 'blue');
		if('ontouchend' in document) {
			document.ontouchend = function() { document.ontouchend = function(e) { touchscreen_touched=false; }; game.next_level(); };
		}
		else {
			document.onmouseup = function() { document.onmouseup=null; game.next_level(); };
		}
	}
	return nearest_goal;
}

previous_time = +new Date();
function draw() {
	requestAnimationFrame(draw);
	current_time = +new Date();
	var dt = current_time - previous_time;
	previous_time = current_time;
	if(dt>500) { return; } //do not count offscreen time
	
	if(game.mode==game.NOT_STARTED) {
		canvas.width = canvas.width;
		
		g.fillStyle='#FFF';
		for(var t=0; t<13; t++) {
			var x = 60*scale*Math.cos((-t*1.4/12+0.2)*Math.PI)+canvas.width/2;
			var y = 60*scale*Math.sin((-t*1.4/12+0.2)*Math.PI)+canvas.height-130*scale;
			g.star(x, y, 6*scale, 5, 0.35).fill();
		}
		
		g.fillStyle='#000';
		g.font=20*scale+'px Times';
		g.fillText("James Stevenson",canvas.width/2-67*scale, canvas.height-10*scale);
		
		q=-0.3;
		s=1;
		g.save();
		g.translate(canvas.width/2, canvas.height-150*scale);
		g.scale(scale, scale);
		
		g.dragon(q,s);
		
		g.restore();
		
		return;
	}
	if(map.defeat) {
		return;
	}
	if(map.victory) {
		return;
	}
	
	controls(dt);
	
	var nearest_goal = game_logic(dt);
	
	info.innerHTML = Math.round(1000/dt)+'fps';
	//canvas.width = canvas.width;
	g.clearRect(0, 0, canvas.width, canvas.height);
	g.save();
	g.scale(scale, scale);
	g.save();
	g.translate(canvas.width/2/scale, canvas.height/scale-50);
	g.rotate(-me.a);
	g.translate(-canvas.width/2/scale, -canvas.height/scale+50);
	g.translate(-me.x+canvas.width/2/scale, -me.y+canvas.height/scale-50);
	
	for(var i=0; i<map.hills.length; i++) {
		var h = map.hills[i];
		if( (h.x-me.x)*(h.x-me.x) + (h.y-me.y)*(h.y-me.y) > look_distance*look_distance ) { continue; }
		
		var grd=g.createRadialGradient(h.x,h.y,5,h.x,h.y,200);//(75,75,5,90,90,100);
		grd.addColorStop(0,'#0A2');
		grd.addColorStop(1,canvas.style.backgroundColor);
		g.fillStyle=grd;
		g.fillRect(h.x-200,h.y-200,400,400);
	}
	
	g.beginPath();
	for (var x=0; x<map.width+1; x+=50) {
		g.moveTo(x, 0);
		g.lineTo(x, map.height);
	}
	for(var y=0; y<map.height+1; y+=50) {
		g.moveTo(0, y);
		g.lineTo(map.width, y);
	}
	g.strokeStyle = "#00A";
	g.stroke();
	
	for(var i=0; i<map.objects.length; i++) {
		var o = map.objects[i];
		if( (o.x-me.x)*(o.x-me.x) + (o.y-me.y)*(o.y-me.y) > look_distance*look_distance ) { continue; }
		g.save();
		if(o.type==CANNON) {
			var c = o;
			g.translate(c.x, c.y);
			g.rotate(-c.a);
			var cannon_width = 10;
			var wheel_width = 5;
			var wheel_length = 30;
			var cannon_length = 40;
			g.fillStyle = c.burned ? '#000' : '#961';
			g.fillRect(cannon_width/2+3, -wheel_length/2, wheel_width, wheel_length);
			g.fillRect(-cannon_width/2-wheel_width-3, -wheel_length/2, wheel_width, wheel_length);
			g.fillRect(-cannon_width/2-3, -5, cannon_width+2*3, 10);
			g.fillStyle = c.burned ? '#000' : '#444';
			g.fillRect(-cannon_width/2, -12-wheel_length/2, cannon_width, cannon_length);
		}
		else if(o.type==WAGON) {
			var w = o;
			g.translate(w.x, w.y);
			g.rotate(-w.a);
			g.fillStyle = w.burned ? '#000' : '#851';
			g.fillRect(-15, -30, 30, 60);
		
			g.fillRect(15+1, 5, 3, 20);
			g.fillRect(-15-3-1, 5, 3, 20);
		
			g.fillRect(15+1, -25, 3, 20);
			g.fillRect(-15-3-1, -25, 3, 20);
		}
		else if(o.type==INFANTRY) {
			var n = o;
			g.translate(n.x, n.y);
			g.rotate(-n.a);
			if(n.cooldown===0.0) { //draw musket
				g.fillStyle=n.burned ? '#000' : '#777';
				g.fillRect(1,-24,2,24);
				g.fillStyle=n.burned ? '#000' : 'brown';
				g.fillRect(1,-18,2,18);
			}
			else { //reload
				g.fillStyle=n.burned ? '#000' : '#777';
				g.fillRect(1,-12,2,12);
				g.fillStyle=n.burned ? '#000' : 'brown';
				g.fillRect(1,-9,2,9);
			}
			g.fillStyle=n.burned ? '#000' : '#F00';
			g.fillRect(-6,-3,12,6);
			g.beginPath();
			g.arc(0, 0, 4, 0, 2*Math.PI);
			g.fillStyle=n.burned ? '#000' : '#FF5';
			g.fill();
		}
		else if(o.type==CAVALRY) {
			var c = o;
			g.translate(c.x, c.y);
			g.rotate(-c.a);
			g.fillStyle=c.burned ? '#000' : '#631';
			//g.fillRect(-6, -18, 6*2, 18*2);
			g.roundRect(-6, -18, 6*2, 18*2, 4).fill();
			g.roundRect(-3, -28, 6, 12, 3).fill();

			g.beginPath();
			g.arc(0, 13, 10, 0.3*Math.PI, 0.7*Math.PI);
			g.lineTo(0, 13);
			
			g.moveTo(0, -27);
			g.arc(0, -27, 12, 0.35*Math.PI, 0.65*Math.PI);
			g.lineTo(0, -27);
			g.fillStyle=c.burned ? '#000' : '#321';
			g.fill();

			g.fillStyle=c.burned ? '#000' : '#777';
			g.fillRect(1,-24,2,24);
			g.fillStyle=c.burned ? '#000' : 'brown';
			g.fillRect(1,-18,2,18);
			
			g.fillStyle=c.burned ? '#000' : '#F00';
			g.fillRect(-6,-3,12,6);
			g.beginPath();
			g.arc(0, 0, 4, 0, 2*Math.PI);
			g.fillStyle=c.burned ? '#000' : '#FF5';
			g.fill();
		}
		else if(o.type==CANNONBALL || o.type==BULLET) {
			var p = o;
			g.beginPath();
			if(p.type==CANNONBALL) {
				g.arc(p.x, p.y, 5, 0, 2*Math.PI);
				g.fillStyle='#222';
			}
			else if(p.type==BULLET) {
				g.arc(p.x, p.y, 2, 0, 2*Math.PI);
				g.fillStyle='#222';
			}
			g.fill();
		}
		g.restore();
	}

	if(nearest_goal) {
		var xx = nearest_goal.x-me.x;
		var yy = nearest_goal.y-me.y;
		var L = Math.sqrt(xx*xx + yy*yy);
		g.beginPath();
		g.moveTo(me.x + 15*xx/L, me.y + 15*yy/L);
		g.lineTo(me.x + 50*xx/L, me.y + 50*yy/L);
		g.quadraticCurveTo( me.x + 40*xx/L, me.y + 40*yy/L,  me.x + 30*xx/L - 10*yy/L, me.y + 30*yy/L + 10*xx/L);
		g.moveTo(me.x + 50*xx/L, me.y + 50*yy/L);
		g.quadraticCurveTo( me.x + 40*xx/L, me.y + 40*yy/L,  me.x + 30*xx/L + 10*yy/L, me.y + 30*yy/L - 10*xx/L);
		g.strokeStyle = '#FFF';
		g.lineWidth = 2;
		g.stroke();
	}
	else { console.log('No goal?'); }
	
	g.restore();
	
	me.sprite_cycle_index += dt*me.sprite_cycle_speed*me.v/me.max_v;
	if(me.sprite_cycle_index>me.sprite_cycle_length) { me.sprite_cycle_index=0; }
	var index = me.sprite_cycle_index|0;
	
	var q = Math.sin(2*Math.PI*me.sprite_cycle_index/me.sprite_cycle_length);
	var s = 1+0.3*q;
	q *= 0.1;
	g.save();
	g.translate(canvas.width/2/scale, canvas.height/scale-50);
	//flames
	g.beginPath();
	g.moveTo(0,-10);
	g.quadraticCurveTo(0,-me.fire_size*0.5, me.fire_size,-me.fire_size);
	g.lineTo(-me.fire_size,-me.fire_size);
	g.quadraticCurveTo(0,-me.fire_size*0.5, 0,-10);
	g.fillStyle = '#F00';
	g.fill();
	g.beginPath();
	g.moveTo(0,-10);
	g.quadraticCurveTo(0,-me.fire_size*0.5, me.fire_size*0.5,-me.fire_size);
	g.lineTo(-me.fire_size*0.5,-me.fire_size);
	g.quadraticCurveTo(0,-me.fire_size*0.5, 0,-10);
	g.fillStyle = '#FF0';
	g.fill();
	//dragon
	g.dragon(q,s);
	//health bar
	g.restore();
	g.fillStyle = '#F00';
	g.fillRect(5, 5, (canvas.width/scale-5*2)*Math.max(me.health/me.max_health, 0), 5);
	g.restore();
}
draw();

</script>
</body>
</html>

